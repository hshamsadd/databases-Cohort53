### What are Aggregate Functions, GROUP BY, HAVING, and DISTINCT?

These are powerful tools in SQL that help you summarize and filter your data in smart ways.

#### Aggregate Functions: Summarizing Your Data

These functions take a bunch of values from a column and give you one single answer. They are great for getting quick summaries.

*   **`COUNT()`:** Counts how many rows (items) there are.
*   **`SUM()`:** Adds up all the numbers in a column.
*   **`AVG()`:** Calculates the average of numbers in a column.
*   **`MIN()`:** Finds the smallest number or the earliest date/alphabetical item in a column.
*   **`MAX()`:** Finds the largest number or the latest date/alphabetical item in a column.

#### `DISTINCT`: Finding Unique Items

This keyword helps you see only the unique values in a column, removing any duplicates.

#### `GROUP BY`: Grouping for Summaries

When you want to use aggregate functions on *groups* of data, you use `GROUP BY`.

#### `HAVING`: Filtering Groups

`HAVING` is like `WHERE`, but it filters groups of data *after* they have been created by `GROUP BY`.

### Simple Examples: Aggregate Functions, GROUP BY, HAVING, DISTINCT

Let's use a simple `Products` table to demonstrate these concepts.

**1. Setting up Tables in pgAdmin 4 (SQL)**

```sql
-- Drop table if it exists to start fresh (optional, for testing)
DROP TABLE IF EXISTS Products;

CREATE TABLE Products (
    product_id INT PRIMARY KEY,
    product_name VARCHAR(100) NOT NULL,
    category VARCHAR(50),
    price DECIMAL(10, 2)
);

INSERT INTO Products (product_id, product_name, category, price) VALUES
(1, 'Laptop', 'Electronics', 1200.00),
(2, 'Mouse', 'Electronics', 25.50),
(3, 'Keyboard', 'Electronics', 75.00),
(4, 'Novel', 'Books', 15.00),
(5, 'Textbook', 'Books', 80.00),
(6, 'T-Shirt', 'Apparel', 20.00),
(7, 'Jeans', 'Apparel', 50.00);
```

#### Running Queries in pgAdmin 4

**`COUNT()` and `DISTINCT` Example:**

```sql
SELECT COUNT(product_id) AS TotalProducts FROM Products;
SELECT COUNT(DISTINCT category) AS UniqueCategoriesCount FROM Products;
SELECT DISTINCT category FROM Products;
```

**`SUM()`, `AVG()`, `MIN()`, `MAX()` with `GROUP BY` Example:**

```sql
SELECT category, SUM(price) AS TotalCategoryPrice FROM Products GROUP BY category;
SELECT category, AVG(price) AS AverageCategoryPrice FROM Products GROUP BY category;
SELECT category, MAX(price) AS MaxPriceInCategory FROM Products GROUP BY category;
```

**`HAVING` Clause Example:**

```sql
SELECT category, SUM(price) AS TotalCategoryPrice FROM Products GROUP BY category HAVING SUM(price) > 100;
```

**2. Checking Summaries with Node.js**

```javascript
import { setupDatabase } from './db_setup.js';

async function createTablesForSummaries(client) {
  await client.query(`
    DROP TABLE IF EXISTS Products CASCADE;

    CREATE TABLE Products (
        product_id INT PRIMARY KEY,
        product_name VARCHAR(100) NOT NULL,
        category VARCHAR(50),
        price DECIMAL(10, 2)
    );
    INSERT INTO Products (product_id, product_name, category, price) VALUES
    (1, 'Laptop', 'Electronics', 1200.00),
    (2, 'Mouse', 'Electronics', 25.50),
    (3, 'Keyboard', 'Electronics', 75.00),
    (4, 'Novel', 'Books', 15.00),
    (5, 'Textbook', 'Books', 80.00),
    (6, 'T-Shirt', 'Apparel', 20.00),
    (7, 'Jeans', 'Apparel', 50.00);
  `);
  console.log('Table for summaries created and populated.');
}

async function getTotalProducts(client) {
    console.log('\n--- Total Products ---');
    const res = await client.query(`SELECT COUNT(product_id) AS TotalProducts FROM Products;`);
    console.log(res.rows[0]);
}

async function getUniqueCategories(client) {
    console.log('\n--- Unique Categories ---');
    const res = await client.query(`SELECT DISTINCT category FROM Products;`);
    res.rows.forEach(row => console.log(row));
}

async function getTotalPriceByCategory(client) {
    console.log('\n--- Total Price by Category ---');
    const res = await client.query(`SELECT category, SUM(price) AS TotalCategoryPrice FROM Products GROUP BY category;`);
    res.rows.forEach(row => console.log(row));
}

async function getCategoriesWithHighTotalSales(client) {
    console.log('\n--- Categories with Total Price > 100 ---');
    const res = await client.query(`SELECT category, SUM(price) AS TotalCategoryPrice FROM Products GROUP BY category HAVING SUM(price) > 100;`);
    res.rows.forEach(row => console.log(row));
}

async function runAllSummaryChecks() {
  let client;
  try {
    client = await setupDatabase(true);
    await createTablesForSummaries(client);
    await getTotalProducts(client);
    await getUniqueCategories(client);
    await getTotalPriceByCategory(client);
    await getCategoriesWithHighTotalSales(client);
  } catch (error) {
    console.error('An error occurred:', error);
  } finally {
    if (client) {
      await client.end();
      console.log('Disconnected from "demo_db".');
    }
  }
}

runAllSummaryChecks();
```

### Exercise

Given a `Sales` table:

**`Sales` Table:**

| sale_id | item_name | quantity | price_per_item |
|---------|-----------|----------|----------------|
| 1       | Apple     | 5        | 1.00           |
| 2       | Banana    | 3        | 0.50           |
| 3       | Apple     | 2        | 1.00           |
| 4       | Orange    | 10       | 0.75           |
| 5       | Banana    | 1        | 0.50           |

1.  **pgAdmin 4:** Write an SQL query to find the total number of items sold for each `item_name`.
2.  **pgAdmin 4:** Write an SQL query to find the average `price_per_item` for all items.
3.  **pgAdmin 4:** Write an SQL query to list `item_name`s that have been sold more than 3 times in total (sum of `quantity`).
4.  **Node.js:** Create a new Node.js script that connects to your database and runs the query from exercise 1. Print the results to the console.

### The Main Idea (Essence)

SQL clauses like `JOIN` help you combine information from different tables. `SELF-JOIN` is a special trick to compare data within the same table. `ALIASES` give temporary nicknames to make your queries easier to read. `Aggregate Functions` (`COUNT`, `SUM`, `AVG`, `MIN`, `MAX`) help you summarize data. `DISTINCT` finds unique values. `GROUP BY` organizes your data into groups for summarizing, and `HAVING` filters those summarized groups. These tools are essential for asking smart questions and getting useful answers from your database!